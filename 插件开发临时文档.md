# NcatBot 插件开发文档

## 1. 项目结构

```python
root/
└── plugins/            # 插件目录
    └── a_plugins/      # 示例插件
        ├── __init__.py # 通过 __all__ 显式注册
        └── main.py
```

## 2. 快速开始

### 2.1 安装开发环境

```bash
cd /Users/fish/vscode/ncatpy/NcatBot
pip install -e .
```

### 2.2 创建插件

```python
from ncatbot.plugins_sys import BasePlugin, Event

class MyPlugin(BasePlugin):
    name = "MyPlugin"        # 插件名称
    version = "1.0.0"        # 插件版本
    dependencies = {}        # 插件依赖

    async def on_load(self):
        """插件加载时调用"""
        # 注册事件处理器
        self.register_handler("test.event", self.handle_event)
  
    async def handle_event(self, event: Event):
        """处理事件"""
        print(f"接收到事件: {event.data}")
```

```python
from .main import MyPlugin

__all__ = ['MyPlugin']
```

## 3. 插件系统核心概念

### 3.1 事件系统

```python
class Event:
    type: str      # 事件类型
    data: dict     # 事件数据
    results: list  # 处理结果
```

### 3.2 插件生命周期

- `on_load()`: 插件加载时调用
- `on_unload()`: 插件卸载时调用
- `handle_xxx()`: 事件处理函数
  事件处理函数并没有命名要求，这里仅做展示

### 3.3 插件间通信

```python
# 发布事件
event = Event("test.event", {"message": "hello"})
await self.event_bus.publish_async(event)

# 订阅事件
self.register_handler("test.event", self.handle_event)
```

@todo 使用装饰器注册

### 3.4 插件依赖管理

```python
class MyPlugin(BasePlugin):
    dependencies = {
        "OtherPlugin": ">=1.0.0"  # 依赖 OtherPlugin 1.0.0 或更高版本
    }
```

## 4. 插件开发最佳实践

### 4.1 插件目录结构

```
my_plugin/
├── __init__.py      # 导出插件类
├── main.py          # 插件主逻辑
├── config.yaml      # 插件配置
└── README.md        # 插件文档
```

### 4.2 异常处理

```python
try:
    result = await self.do_something()
except Exception as e:
    self.logger.error(f"操作失败: {e}")
    return None
```

### 4.3 配置管理

```python
# 读取插件配置
config = self.meta_data.get("my_plugin", {})
api_key = config.get("api_key")
```

### 4.4 日志记录

```python
from ncatbot.logger import get_log
loger = get_log('name')
loger.info('info')
```

## 5. 示例插件参考

请参考 a_plugins 目录下的示例插件:

```python
from ncatbot.plugins_sys import BasePlugin, Event

class Test(BasePlugin):
    name = "Test"
    version = "1.0.0"
  
    async def on_load(self):
        self.register_handler("ncatbot\.group|ncatbot\.private", self.handle_test)
  
    async def handle_test(self, event: Event):
        print(f"处理事件: {event.data}")
```

更多示例和API文档请参考源代码注释。
